package autoload

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"github.com/aras/presto/internal/parser"
	"github.com/aras/presto/internal/resolver"
)

// Generator generates autoload files
type Generator struct {
	vendorDir string
}

// NewGenerator creates a new autoload generator
func NewGenerator() *Generator {
	return &Generator{
		vendorDir: "vendor",
	}
}

// Generate generates autoload.php and related files
func (g *Generator) Generate(composer *parser.ComposerJSON, packages []*resolver.Package) error {
	if err := os.MkdirAll(g.vendorDir, 0755); err != nil {
		return err
	}

	if err := g.generateAutoloadPHP(); err != nil {
		return err
	}

	if err := g.generatePSR4(composer, packages); err != nil {
		return err
	}

	return nil
}

// generateAutoloadPHP generates the main autoload.php file
func (g *Generator) generateAutoloadPHP() error {
	content := `<?php
// autoload.php @generated by Presto
require_once __DIR__ . '/autoload_psr4.php';
`
	path := filepath.Join(g.vendorDir, "autoload.php")
	return os.WriteFile(path, []byte(content), 0644)
}

// generatePSR4 generates PSR-4 autoload mappings
func (g *Generator) generatePSR4(composer *parser.ComposerJSON, packages []*resolver.Package) error {
	var mappings strings.Builder
	mappings.WriteString("<?php\n\n// autoload_psr4.php @generated by Presto\n\n")
	mappings.WriteString("return array(\n")

	for namespace, path := range composer.Autoload.PSR4 {
		mappings.WriteString(fmt.Sprintf("    '%s' => '%s',\n", namespace, path))
	}

	mappings.WriteString(");\n")

	path := filepath.Join(g.vendorDir, "autoload_psr4.php")
	return os.WriteFile(path, []byte(mappings.String()), 0644)
}
